<!DOCTYPE html>
<html>
	<head>
		<title>Visualizing Thing</title>
		<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
	</head>
	<body>
		<div class="container mt-5">
			<div class="card">
				<div class="card-header">Chart</div>
				<div class="card-body">
					<div class="col-12 mx-auto">
						<canvas id="myChart"></canvas>
					</div>
				</div>
			</div>
		</div>
		<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
		<script type="text/javascript">
			const defColors = ["#36a2eb", "#ff63849F", "#4bc0c0AF", "#ff9f4016", "#9966ffDF", "#ffcd569F", "#c9cbcf"];
			let cMax = 6.0;
			const cardHeader = document.querySelector(".card-header");
			const ctx = document.querySelector("#myChart");

			let data = {
			  labels: [],
			  datasets: [
				{
					label: 'Harmonic Tension',
					data: [],
					//cubicInterpolationMode: 'monotone',
					tension: 0.5,
					order: 4,
					pointRadius: 0,
					borderWidth: 2,
					borderColor: defColors[0],
					backgroundColor: defColors[0]
				},
				{
					label: 'Chordal ACT',
					data: [],
					//cubicInterpolationMode: 'monotone',
					tension: 0.5,
					order: 3,
					pointRadius: 0,
					borderWidth: 2.5,
					borderColor: defColors[1],
					backgroundColor: defColors[1]
				},
				{
					label: 'Melodic ACT',
					data: [],
					//cubicInterpolationMode: 'monotone',
					tension: 0.5,
					order: 2,
					pointRadius: 0,
					borderWidth: 3.6,
					borderColor: defColors[5],
					backgroundColor: defColors[5]
				},
				{
					label: 'Total ACT',
					data: [],
					tension: 0.5,
					order: 1,
					pointRadius: 0,
					borderWidth: 2.7,
					borderColor: defColors[4],
					backgroundColor: defColors[4]
				},
				{
					label: 'Total ACT (alternative)',
					data: [],
					tension: 0.5,
					order: 0,
					pointRadius: 0,
					borderWidth: 3,
					borderColor: defColors[2],
					backgroundColor: defColors[2]
				},
				{
					label: 'Melody Overtension',
					data: [],
					tension: 0.5,
					order: 5,
					fill: true,
					pointRadius: 0,
					borderWidth: 5.0,
					borderColor: defColors[3],
					backgroundColor: defColors[3]
				}
			  ]
			};

			const myChart = new Chart(ctx, {
				type: 'line',
				data: data,
				options: {
					animation: false,
					scales: {
						y: {
							beginAtZero: true,
							max: cMax
						}
					}
				}
			});
			
			let datas, maxData;
			
			let socket;
			
			function connect() {
				socket = new WebSocket("ws://127.0.0.1:9080");
				socket.onmessage = ({ data }) => {
					try {
						let d = JSON.parse(data);
						//console.log(d);
						myChart.data.labels.push(d.time.toFixed(2));
						myChart.data.datasets[0].data.push(d.tht);
						myChart.data.datasets[1].data.push(d.act[1]);
						myChart.data.datasets[2].data.push(d.act[0]);
						myChart.data.datasets[3].data.push((d.act[0] + d.act[1]) / 2.0);
						let chordStrong = d.act[1] > d.act[0];
						myChart.data.datasets[4].data.push(chordStrong ? d.act[1] : d.act[0]);
						
						let maxData = 0;
						let mc;
						for (i = 0; i < 5; i++) {
							mc = myChart.data.datasets[i].data;
							for (j = 0; j < mc.length; j++) {
								if (mc[j] > maxData) maxData = 0 + mc[j];
							}
							//datas.push(myChart.data.datasets[i].data[myChart.data.datasets[i].data.length - 1]);
						}
						//datas.sort((a, b) => b - a);
						//maxData = datas[0];
						if (maxData > cMax) {
							myChart.options.scales.y.max = maxData;
						} else {
							myChart.options.scales.y.max = cMax;
						}
						myChart.data.datasets[5].data.push(chordStrong ? 0.0 : myChart.options.scales.y.max);
						//myChart.data.datasets[5].data = myChart.data.datasets[5].data.map(a => a > 0.0 ? myChart.options.scales.y.max : a);
						cardHeader.textContent = `Tension Chart | Currently More Tense: ${chordStrong ? "Chords" : "Melody"}`;
						//myChart.update();
					} catch(e) {
					}
				};
				
				socket.onclose = (e) => {
					socket = null;
					setTimeout(() => {
						connect();
					}, 1000);
				}
				
				socket.onerror = (e) => {
					socket.close();
					socket = null;
				}
			}
			
			connect();
			
			document.addEventListener("keydown", (e) => {
				//e = e || window.event;
				if (socket) socket.send(e.keyCode);
				switch (e.keyCode) {
					case 49:
						maxSecs -= 0.1;
						if (maxSecs < 0.1) maxSecs = 0.1;
						maxAmount = fps * maxSecs;
						break;
					case 50:
						maxSecs += 0.1;
						maxAmount = fps * maxSecs;
						break;
					case 51:
						cMax -= 0.1;
						if (cMax < 0.1) cMax = 0.1;
						break;
					case 52:
						cMax += 0.1;
						break;
				}
			});
			
			document.addEventListener("keyup", (e) => {
				//e = e || window.event;
				if (socket) socket.send(e.keyCode + 2000);
			});
			
			const fps = 60;
			let maxSecs = 5;
			let maxAmount = fps * maxSecs;
			let msPerFrame = 1000 / fps;
			
			function onFrame() {
				while (myChart.data.labels.length > maxAmount) {
					myChart.data.labels.shift();
					myChart.data.datasets[0].data.shift();
					myChart.data.datasets[1].data.shift();
					myChart.data.datasets[2].data.shift();
					myChart.data.datasets[3].data.shift();
					myChart.data.datasets[4].data.shift();
					myChart.data.datasets[5].data.shift();
				}
				myChart.update();
				setTimeout(() => {
					requestAnimationFrame(onFrame);
				}, msPerFrame);
			}
			
			requestAnimationFrame(onFrame);
		</script>
	</body>
</html>